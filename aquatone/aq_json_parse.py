import json
import pandas as pd
import os
import sys
from urllib.parse import urlparse


def save2csv(con_list, fname):
    pf = pd.DataFrame(con_list,
                      columns=["ID", "URL", "Port", "IPs", "Title", "Status", "Banner", "Host", "Type", "Other"])
    pf.to_csv(fname, index=False, encoding="utf-8")
    print("Save file at  %s" % (con_list))


def parsejson(fpath):
    csv_data = []
    with open(fpath, "r", encoding="utf-8") as f:
        jsonfile = f.read()
        data = json.loads(jsonfile)
        pages = data["pages"]
    num = 0
    for i in pages:
        num += 1
        csv_line = {}
        url = pages[i]["url"]
        _url = urlparse(url)
        port = _url.port
        if port is None:
            port = 80 if _url.scheme == "http" else 443
        host = pages[i]["hostname"]
        if pages[i]["addrs"] is None:
            ips = 'None'
        else:
            ips = ",".join(pages[i]["addrs"])
        status = pages[i]["status"]
        status = status.strip()[:3]
        title = pages[i]["pageTitle"]
        tags = pages[i]["tags"]
        tag = []
        if not tags is None:
            for item in tags:
                tag.append(item.get("text"))
        banner = ",".join(tag)
        csv_line["ID"] = num
        csv_line["URL"] = url
        csv_line["Port"] = port
        csv_line["Host"] = host
        csv_line["IPs"] = ips
        csv_line["Status"] = status
        csv_line["Title"] = title
        csv_line["Banner"] = banner
        csv_line["Other"] = ""
        # print(url,port,host,ips,status,title,banner)
        csv_data.append(csv_line)
    return csv_data


if __name__ == "__main__":
    fpath = sys.argv[1]
    if not os.path.isabs(fpath):
        fpath = os.path.abspath(fpath)
    fdir, name = os.path.split(fpath)
    name, ext = os.path.splitext(name)
    con_list = parsejson(fpath)
    outpath = os.path.join(fdir, name + ".csv")
    save2csv(con_list, outpath)
