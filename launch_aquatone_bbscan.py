import argparse
import os
import sys
from time import sleep
import public_pool
from public_pool import get_flag_value, chance_flag_value
import datetime


def parse_args():
    parser = argparse.ArgumentParser(epilog='\tExample: \r\npython ' + sys.argv[0] + " -u http://www.baidu.com")
    parser.add_argument("-d", "--domain", help="domain name")
    return parser.parse_args()


# aquatone
def launch_aquatone():
    os.system('mkdir {}/aquatone'.format(domain_store_dir))
    os.chdir('{}aquatone'.format(docker_pentest_information_gather_volume_map_dir))
    os.system('cat {}/shuize/{}_all_subdomains.txt|./aquatone -ports large -http-timeout 6000 -scan-timeout 200 '
              '-screenshot-timeout 60000  -chrome-path /usr/bin/chromium-browser -out {}/aquatone/'.format(
        domain_store_dir, domain, domain_store_dir))
    # os.chdir('{}aquatone'.format(domain_store_dir))
    # os.system('python {}/aquatone/aq_json_parse.py aquatone_session.json'.format(docker_pentest_information_gather_volume_map_dir))


# bbscan
def launch_bbscan():
    os.chdir('{}bbscan'.format(docker_pentest_information_gather_volume_map_dir))
    # cat aquatone_urls.txt to urls.txt
    # os.system('cat {}/aquatone/aquatone_urls.txt >> {}/../urls.txt'.format(domain_store_dir, domain_store_dir))

    os.system('python BBScan.py -f {}/aquatone/aquatone_urls.txt'.format(domain_store_dir))
    os.system('if ls ./report/*.html 1> /dev/null 2>&1; then mv ./report/*.html {}bbscan.html;fi'.format(
        domain_store_dir))


def launch_endpoints_scan():
    os.system('mkdir {}/endpoints_scan'.format(domain_store_dir))
    os.system(
        'cat {}/aquatone/aquatone_urls.txt | xargs -n1 -I{} bash -c "cat endpoints/endpoints.txt | xargs -n1 -I[] curl -s -o /dev/null -w \'%{} {}[]\n\' {}[]"|tee {}endpoints_scan/subdomain_endpoint.txt'.format(
            domain_store_dir, '', 'http_code', '', '', domain_store_dir))


def print_dir():
    print(domain_store_dir)
    os.system('l{}{}'.format('', 's'))



if __name__ == '__main__':
    args = parse_args()
    domain = args.domain

    docker_pentest_information_gather_volume_map_dir = public_pool.docker_pentest_information_gather_volume_map_dir
    domain_store_dir = public_pool.get_or_create_domain_store_dir(domain)
    # print datetime.datetime.now()
    launch_aquatone()
    launch_bbscan()

    # prevent bbscan results not move to result floder
    sleep(3)
